<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>M√≥n qu√† nh·ªè ‚ú®</title>
    <style>
        * {
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }
        body {
            margin: 0;
            padding: 0;
            background: #000;
            overflow: hidden;
            font-family: 'Arial', sans-serif;
            touch-action: none;
            -webkit-user-select: none;
            user-select: none;
            -webkit-touch-callout: none;
        }
        canvas {
            display: block;
            width: 100vw;
            height: 100vh;
            /* t·ªëi ∆∞u hi·ªáu su·∫•t v·∫Ω tr√™n iOS */
            will-change: transform;
        }
        #ui {
            position: absolute;
            top: 0; left: 0;
            width: 100%; height: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 10;
            pointer-events: none;
        }
        button {
            padding: 16px 42px;
            font-size: 20px;
            font-weight: 600;
            background: linear-gradient(135deg, #ff4d6d, #ff8aa1);
            color: white;
            border: none;
            border-radius: 60px;
            cursor: pointer;
            box-shadow: 0 0 25px rgba(255, 75, 100, 0.7);
            transition: 0.2s;
            animation: pulse 1.8s infinite ease-in-out;
            pointer-events: auto;
            z-index: 20;
            border: 1px solid rgba(255,255,255,0.3);
            backdrop-filter: blur(2px);
            letter-spacing: 1px;
        }
        button:active {
            transform: scale(0.94);
            box-shadow: 0 0 35px rgba(255, 100, 120, 0.9);
        }
        @keyframes pulse {
            0% { transform: scale(1); box-shadow: 0 0 15px rgba(255, 77, 109, 0.5); }
            50% { transform: scale(1.05); box-shadow: 0 0 40px rgba(255, 138, 161, 0.9); }
            100% { transform: scale(1); box-shadow: 0 0 15px rgba(255, 77, 109, 0.5); }
        }
        #message, #sub-message {
            display: none;
            font-weight: 500;
            text-align: center;
            position: absolute;
            left: 50%;
            transform: translate(-50%, -50%);
            white-space: nowrap;
            z-index: 30;
            letter-spacing: 3px;
            text-shadow: 0 0 20px currentColor, 0 0 40px currentColor;
        }
        #message {
            top: 42%;
            font-size: 7vw;
            color: #ffb8d9;
            animation: glowReveal 2.8s cubic-bezier(0.2, 0.9, 0.3, 1.2) forwards;
            opacity: 0;
        }
        #sub-message {
            top: 58%;
            font-size: 10vw;
            color: #a9e0ff;
            animation: glowReveal 2.4s 0.3s cubic-bezier(0.2, 0.9, 0.3, 1.2) forwards;
            opacity: 0;
        }
        @keyframes glowReveal {
            0% { opacity: 0; transform: translate(-50%, -30%) scale(0.6); filter: blur(12px); }
            40% { opacity: 1; filter: blur(2px); }
            100% { opacity: 1; transform: translate(-50%, -50%) scale(1); filter: blur(0); }
        }
        
        /* Hi·ªáu ·ª©ng m·ªù d·∫ßn v√† bi·∫øn m·∫•t */
        @keyframes fadeOutMsg {
            0% { opacity: 1; transform: translate(-50%, -50%) scale(1); filter: blur(0); }
            100% { opacity: 0; transform: translate(-50%, -50%) scale(1.1); filter: blur(10px); }
        }

        #stats {
            position: absolute;
            bottom: max(8px, env(safe-area-inset-bottom));
            right: 12px;
            color: rgba(255,255,240,0.15);
            font-size: 11px;
            z-index: 40;
            pointer-events: none;
            font-family: monospace;
        }
    </style>
</head>
<body>

    <audio id="bgm" src="nhaccuatoi1.mp3" preload="auto" playsinline></audio>

    <div id="ui">
        <button id="startBtn">M·ªü ƒëi üíñ</button>
        <div id="message">NƒÉm sau
             <br/>c√πng ng·∫Øm ph√°o hoa
            <br/> nha B√†‚ù§Ô∏è</div>
        <div id="sub-message">üòä</div>
    </div>
   

    <canvas id="canvas"></canvas>

    <script>
        (function() {
            // === C·∫•u h√¨nh n√¢ng cao cho iPhone: s·∫Øc n√©t, nhi·ªÅu hi·ªáu ·ª©ng, ch·ªëng gi·∫≠t ===
            const canvas = document.getElementById('canvas');
            const ctx = canvas.getContext('2d');
            
            let cw, ch;
            let dpr = window.devicePixelRatio || 1;

            // Resize th√¥ng minh, gi·ªØ ƒë·ªô ph√¢n gi·∫£i cao
            function resizeCanvas() {
                cw = window.innerWidth;
                ch = window.innerHeight;
                dpr = window.devicePixelRatio || 1;
                
                canvas.width = cw * dpr;
                canvas.height = ch * dpr;
                canvas.style.width = `${cw}px`;
                canvas.style.height = `${ch}px`;
                ctx.setTransform(1, 0, 0, 1, 0, 0); // reset transform
                ctx.scale(dpr, dpr);
                
                // lu√¥n gi·ªØ ch·∫ø ƒë·ªô h√≤a tr·ªôn s√°ng
                ctx.globalCompositeOperation = 'source-over'; 
            }

            resizeCanvas();

            let resizeTimeout;
            window.addEventListener('resize', () => {
                clearTimeout(resizeTimeout);
                resizeTimeout = setTimeout(resizeCanvas, 80);
            });

            // === ƒêi·ªÉm m·∫´u cho c√°c h√¨nh d·∫°ng ƒë·∫∑c bi·ªát (ƒë·ªô ph√¢n gi·∫£i cao h∆°n) ===
            
            // Ng√¥i sao 5 c√°nh chi ti·∫øt (m·ªãn h∆°n)
            function createStarPoints(resolution = 8) {
                const pts = [];
                for (let i = 0; i < 5; i++) {
                    const a1 = (i * 2 * Math.PI) / 5 - Math.PI / 2;
                    const a2 = ((i + 0.5) * 2 * Math.PI) / 5 - Math.PI / 2;
                    const a3 = ((i + 1) * 2 * Math.PI) / 5 - Math.PI / 2;
                    const p1 = { x: Math.cos(a1), y: Math.sin(a1) };
                    const p2 = { x: Math.cos(a2) * 0.42, y: Math.sin(a2) * 0.42 };
                    const p3 = { x: Math.cos(a3), y: Math.sin(a3) };
                    
                    for (let j = 0; j <= resolution; j++) {
                        const t = j / resolution;
                        pts.push({ x: p1.x * (1 - t) + p2.x * t, y: p1.y * (1 - t) + p2.y * t });
                        pts.push({ x: p2.x * (1 - t) + p3.x * t, y: p2.y * (1 - t) + p3.y * t });
                    }
                }
                return pts;
            }

            const starPoints = createStarPoints(10); // m·ªãn h∆°n

            // S·ªë 10 c√°ch ƒëi·ªáu (cho "10 ƒëi·ªÉm" ho·∫∑c ng√†y ƒë·∫∑c bi·ªát)
            function createTenPoints() {
                const strokes = [
                    [2, 0, 8, 0], [5, 0, 5, 10],  // s·ªë 1
                    [10, 0, 14, 0], [12, 0, 12, 10], [10, 10, 14, 10], // s·ªë 0 ph·∫ßn tr√™n
                    [16, 2, 20, 2], [16, 5, 20, 5], [16, 8, 20, 8], [16, 2, 16, 8], // s·ªë 0 c√°ch ƒëi·ªáu
                    [18, 0, 18, 1.5], [18, 0, 20, 1.5], // n√©t cong nh·∫π
                    [22, 0, 22, 10], [22, 0, 28, 10], [28, 0, 28, 10] // n√©t cong kh√°c
                ];

                const points = [];
                strokes.forEach(([x1, y1, x2, y2]) => {
                    for (let s = 0; s <= 6; s++) { // tƒÉng ƒë·ªô m·ªãn
                        const t = s / 6;
                        points.push({ x: (x1 + (x2 - x1) * t) - 15, y: (y1 + (y2 - y1) * t) - 5 });
                    }
                });
                return points;
            }

            const tenPoints = createTenPoints();

            // H√¨nh b∆∞·ªõm (parametric)
            function generateButterflyPoints(scale = 1, steps = 40) {
                const pts = [];
                for (let i = 0; i <= steps; i++) {
                    const t = (i / steps) * Math.PI * 2;
                    const r = Math.exp(Math.sin(t)) - 2.4 * Math.cos(4*t) + Math.pow(Math.sin(t/12), 5);
                    const x = Math.sin(t) * r * scale;
                    const y = Math.cos(t) * r * scale;
                    pts.push({ x, y });
                }
                return pts;
            }

            const butterflyPoints = generateButterflyPoints(1.2, 50);

            // H√¨nh b√¥ng hoa (nhi·ªÅu c√°nh)
            function generateFlowerPoints(petals = 8, steps = 30) {
                const pts = [];
                for (let i = 0; i <= steps; i++) {
                    const t = (i / steps) * Math.PI * 2;
                    const r = Math.cos(petals * t) * 0.8 + 1.2; // d·∫°ng hoa
                    const x = Math.cos(t) * r;
                    const y = Math.sin(t) * r;
                    pts.push({ x, y });
                }
                return pts;
            }

            const flowerPoints = generateFlowerPoints(7, 50);

            // V∆∞∆°ng mi·ªán ƒë∆°n gi·∫£n
            function generateCrownPoints() {
                return [
                    { x: -1.5, y: 0.5 }, { x: -1.2, y: -1 }, { x: -0.8, y: 0.2 }, { x: -0.4, y: -1 },
                    { x: 0, y: 0.8 }, { x: 0.4, y: -1 }, { x: 0.8, y: 0.2 }, { x: 1.2, y: -1 },
                    { x: 1.5, y: 0.5 }, { x: 1.2, y: 1 }, { x: 0.7, y: 0.8 }, { x: 0, y: 1.3 },
                    { x: -0.7, y: 0.8 }, { x: -1.2, y: 1 }, { x: -1.5, y: 0.5 }
                ];
            }

            const crownPoints = generateCrownPoints();

            // === TƒÉng k√≠ch th∆∞·ªõc pool v√† particle cho n√©t h∆°n ===
            const MAX_PARTICLES = 1000; // iPhone v·∫´n m∆∞·ª£t (ƒë√£ test)
            let shells = [];
            let particles = [];
            let particlePool = [];

            class Particle {
                constructor(x, y, vx, vy, color, decay, gravity, isSparkle) {
                    this.reset(x, y, vx, vy, color, decay, gravity, isSparkle);
                }
                reset(x, y, vx, vy, color, decay = 0.012, gravity = 0.04, isSparkle = false) {
                    this.x = x; this.y = y; this.vx = vx; this.vy = vy;
                    this.color = color; this.alpha = 1; this.decay = decay;
                    this.gravity = gravity; this.friction = 0.96;
                    this.isSparkle = isSparkle;
                    // b√°n k√≠nh ƒëa d·∫°ng, s·∫Øc n√©t h∆°n
                    this.baseRadius = Math.random() * 1.8 + 1.2; 
                    this.active = true;
                    return this;
                }
                update() {
                    this.vx *= this.friction; 
                    this.vy *= this.friction;
                    this.vy += this.gravity; 
                    this.x += this.vx; 
                    this.y += this.vy;
                    this.alpha -= this.decay;
                    return this.alpha > 0;
                }
                draw() {
                    ctx.save();
                    ctx.globalAlpha = this.alpha;
                    // nh·∫•p nh√°y nh·∫π cho sparkle
                    const radius = this.isSparkle ? this.baseRadius * (0.8 + 0.6 * Math.random()) : this.baseRadius;
                    ctx.beginPath();
                    ctx.arc(this.x, this.y, radius, 0, Math.PI * 2);
                    ctx.fillStyle = this.color;
                    ctx.fill();
                    ctx.restore();
                }
            }

            class Shell {
                constructor(startX, startY, targetX, targetY, type) {
                    this.reset(startX, startY, targetX, targetY, type);
                }
                reset(startX, startY, targetX, targetY, type) {
                    this.x = startX; this.y = startY;
                    this.targetX = targetX; this.targetY = targetY;
                    this.type = type; 
                    this.speed = 12 + Math.random() * 5; // nhanh h∆°n ch√∫t
                    const angle = Math.atan2(targetY - startY, targetX - startX);
                    this.vx = Math.cos(angle) * this.speed;
                    this.vy = Math.sin(angle) * this.speed;
                    this.color = 'rgba(255,240,200,0.9)';
                    return this;
                }
                update() {
                    this.x += this.vx; this.y += this.vy;
                    // v·ªát s√°ng m·∫£nh h∆°n
                    if (Math.random() > 0.6) addParticle(this.x, this.y, 0, 0, '#fff9e6', 0.08, 0, false);
                    if (Math.abs(this.x - this.targetX) < this.speed && Math.abs(this.y - this.targetY) < this.speed) {
                        explode(this.x, this.y, this.type);
                        return false;
                    }
                    return true;
                }
                draw() {
                    ctx.beginPath();
                    ctx.arc(this.x, this.y, 2.2, 0, Math.PI * 2);
                    ctx.fillStyle = this.color;
                    ctx.fill();
                }
            }

            function addParticle(x, y, vx, vy, color, decay, gravity, isSparkle) {
                if (particles.length >= MAX_PARTICLES) particles.splice(0, Math.floor(MAX_PARTICLES * 0.15));
                if (particlePool.length > 0) {
                    particles.push(particlePool.pop().reset(x, y, vx, vy, color, decay, gravity, isSparkle));
                } else {
                    particles.push(new Particle(x, y, vx, vy, color, decay, gravity, isSparkle));
                }
            }

            function explode(x, y, type) {
                let colorBase = `hsl(${Math.random() * 360}, 100%, 65%)`;
                let isSparkle = true; // ƒëa s·ªë ƒë·ªÅu lung linh
                
                switch(type) {
                    case 'heart':
                        colorBase = `hsl(${Math.random() * 20 + 330}, 100%, 68%)`;
                        for (let i = 0; i < Math.PI * 2; i += 0.1) { // d√†y h∆°n
                            const vx = 16 * Math.pow(Math.sin(i), 3) * 0.28;
                            const vy = -(13 * Math.cos(i) - 5 * Math.cos(2*i) - 2 * Math.cos(3*i) - Math.cos(4*i)) * 0.28;
                            addParticle(x, y, vx, vy, colorBase, 0.012, 0.02, true);
                        }
                        break;
                    case 'star':
                        colorBase = `hsl(${Math.random() * 40 + 40}, 100%, 70%)`;
                        for (let i = 0; i < starPoints.length; i++) {
                            addParticle(x, y, starPoints[i].x * 6, starPoints[i].y * 6, colorBase, 0.013, 0.025, true);
                        }
                        break;
                    case 'ring':
                        const c1 = `hsl(${Math.random() * 360}, 100%, 65%)`;
                        const c2 = `hsl(${Math.random() * 360}, 100%, 75%)`;
                        for (let i = 0; i < Math.PI * 2; i += 0.25) 
                            addParticle(x, y, Math.cos(i) * 3.5, Math.sin(i) * 3.5, c1, 0.012, 0.02, true);
                        for (let i = 0; i < Math.PI * 2; i += 0.18) 
                            addParticle(x, y, Math.cos(i) * 7.5, Math.sin(i) * 7.5, c2, 0.01, 0.02, true);
                        break;
                    case 'spiral':
                        const c = `hsl(${Math.random() * 360}, 100%, 70%)`;
                        for (let i = 0; i < 50; i++) {
                            const angle = 0.22 * i; const speed = (i/50)*12;
                            addParticle(x, y, Math.cos(angle)*speed, Math.sin(angle)*speed, c, 0.012, 0.02, true);
                            addParticle(x, y, Math.cos(angle+Math.PI)*speed, Math.sin(angle+Math.PI)*speed, c, 0.012, 0.02, true);
                        }
                        break;
                    case 'willow':
                        const wc = `hsl(${Math.random()*40+30}, 100%, 70%)`;
                        for (let i = 0; i < 70; i++) {
                            const angle = Math.random() * Math.PI * 2; const speed = Math.random() * 5 + 1.5;
                            const p = new Particle(x, y, Math.cos(angle)*speed, Math.sin(angle)*speed, wc, 0.0045, 0.045, true);
                            p.friction = 0.9; particles.push(p);
                        }
                        break;
                    case 'ten':
                        colorBase = `hsl(${Math.random()*40+270}, 100%, 70%)`;
                        for (let i = 0; i < tenPoints.length; i++) {
                            const jitterX = (Math.random()-0.5)*0.6;
                            const jitterY = (Math.random()-0.5)*0.6;
                            addParticle(x, y, (tenPoints[i].x+jitterX)*3.5, (tenPoints[i].y+jitterY)*3.5, colorBase, 0.012, 0.022, true);
                        }
                        break;
                    // === C√ÅC H√åNH D·∫†NG M·ªöI B·∫ÆT M·∫ÆT ===
                    case 'butterfly':
                        colorBase = `hsl(${Math.random()*60+180}, 100%, 65%)`;
                        for (let i = 0; i < butterflyPoints.length; i++) {
                            addParticle(x, y, butterflyPoints[i].x * 5, butterflyPoints[i].y * 5, colorBase, 0.012, 0.02, true);
                        }
                        break;
                    case 'flower':
                        colorBase = `hsl(${Math.random()*60+300}, 100%, 70%)`;
                        for (let i = 0; i < flowerPoints.length; i++) {
                            addParticle(x, y, flowerPoints[i].x * 6, flowerPoints[i].y * 6, colorBase, 0.011, 0.02, true);
                        }
                        break;
                    case 'crown':
                        colorBase = `hsl(${Math.random()*30+50}, 100%, 65%)`;
                        for (let i = 0; i < crownPoints.length; i++) {
                            addParticle(x, y, crownPoints[i].x * 5, crownPoints[i].y * 5, colorBase, 0.013, 0.025, true);
                        }
                        break;
                    case 'rainbow':
                        for (let i = 0; i < 120; i++) {
                            const angle = Math.random() * Math.PI*2;
                            const speed = Math.random() * 6 + 2;
                            const hue = (i * 7) % 360;
                            addParticle(x, y, Math.cos(angle)*speed, Math.sin(angle)*speed, `hsl(${hue},100%,65%)`, 0.014, 0.02, true);
                        }
                        break;
                    default: // normal
                        for (let i = 0; i < 45; i++) { 
                            const angle = Math.random() * Math.PI * 2; 
                            const speed = Math.random() * 7;
                            addParticle(x, y, Math.cos(angle)*speed, Math.sin(angle)*speed, colorBase, 0.014, 0.035, true);
                        }
                }
            }

            let isRunning = false;
            let startTime = 0;
            let lastLaunch = 0;
            
            // C√°c bi·∫øn ki·ªÉm so√°t tr·∫°ng th√°i hi·ªán/·∫©n ch·ªØ
            let messageShown = false;
            let subMessageShown = false;
            let messageHidden = false;
            let subMessageHidden = false;

            function loop(timestamp) {
                if (!isRunning) return;
                if (!startTime) startTime = timestamp;
                const elapsed = timestamp - startTime;

                // K·ªπ thu·∫≠t x√≥a m·ªù m∆∞·ª£t, gi·ªØ v·ªát d√†i h∆°n nh∆∞ng v·∫´n s·∫Øc n√©t
                const fadeAmount = particles.length > 600 ? 0.3 : 0.18; 
                ctx.globalCompositeOperation = 'destination-out';
                ctx.fillStyle = `rgba(0, 0, 0, ${fadeAmount})`;
                ctx.fillRect(0, 0, cw, ch);
                ctx.globalCompositeOperation = 'lighter'; // hi·ªáu ·ª©ng ch·ªìng s√°ng

                // ----- K·ªäCH B·∫¢N PHONG PH√ö H∆†N (0-59 gi√¢y) -----
                let launchInterval = 1000;
                let availableTypes = ['normal', 'ring'];
                let numberOfShells = 1;

                if (elapsed > 7000) availableTypes.push('star');
                if (elapsed > 10000) availableTypes.push('heart');
                if (elapsed > 16000) availableTypes.push('spiral');
                if (elapsed > 22000) availableTypes.push('flower', 'butterfly');
                if (elapsed > 28000) availableTypes.push('crown', 'rainbow');
                if (elapsed > 32000) availableTypes.push('willow');
                if (elapsed > 38000) availableTypes.push('ten');

                // TƒÉng d·∫ßn t·ªëc ƒë·ªô
                if (elapsed > 15000) launchInterval = 750;
                if (elapsed > 25000) launchInterval = 600;
                if (elapsed > 35000) launchInterval = 450;

                // Grand finale t·ª´ 45s - 55s: b√πng n·ªï ƒëa d·∫°ng
                if (elapsed > 42000 && elapsed < 51000) {
                    launchInterval = 280;
                    numberOfShells = 2;
                    availableTypes = ['heart', 'star', 'ring', 'spiral', 'butterfly', 'flower', 'crown', 'rainbow', 'willow', 'ten'];
                }

                // D·ª´ng b·∫Øn sau 55s
                if (elapsed > 52000) {
                    launchInterval = 999999;
                }

                // B·∫Øn ph√°o
                if (shells.length < 10 && elapsed < 52000 && timestamp - lastLaunch > launchInterval) {
                    for(let i = 0; i < numberOfShells; i++) {
                        const startX = cw/2 + (Math.random()-0.5)*cw*0.7;
                        const targetX = startX + (Math.random()-0.5)*250;
                        const targetY = Math.random()*(ch*0.35) + 50;
                        const type = availableTypes[Math.floor(Math.random() * availableTypes.length)];
                        shells.push(new Shell(startX, ch, targetX, targetY, type));
                    }
                    lastLaunch = timestamp;
                }

                // V·∫Ω v√† c·∫≠p nh·∫≠t
                for (let i = shells.length-1; i>=0; i--) {
                    shells[i].draw();
                    if (!shells[i].update()) shells.splice(i,1);
                }
                for (let i = particles.length-1; i>=0; i--) {
                    particles[i].draw();
                    if (!particles[i].update()) {
                        if (particlePool.length < 400) particlePool.push(particles[i]);
                        particles.splice(i,1);
                    }
                }

                // --- HI·ªÜN CH·ªÆ ---
                if (elapsed > 52000 && !messageShown) {
                    document.getElementById('message').style.display = 'block';
                    messageShown = true;
                }
                if (elapsed > 52500 && !subMessageShown) {
                    document.getElementById('sub-message').style.display = 'block';
                    subMessageShown = true;
                }

                // --- ·∫®N CH·ªÆ D·∫¶N ƒêI SAU 5 GI√ÇY (M·ªöI TH√äM) ---
                // Ch·ªØ ch√≠nh hi·ªán ·ªü gi√¢y 55 => M·∫•t ·ªü gi√¢y 60
                if (elapsed > 60000 && !messageHidden) {
                    document.getElementById('message').style.animation = 'fadeOutMsg 2s forwards';
                    messageHidden = true;
                }
                // Ch·ªØ ph·ª• hi·ªán ·ªü gi√¢y 57.5 => M·∫•t ·ªü gi√¢y 62.5
                if (elapsed > 62500 && !subMessageHidden) {
                    document.getElementById('sub-message').style.animation = 'fadeOutMsg 2s forwards';
                    subMessageHidden = true;
                }

                requestAnimationFrame(loop);
            }

            document.getElementById('startBtn').addEventListener('click', () => {
                document.getElementById('startBtn').style.display = 'none';
                const audio = document.getElementById('bgm');
                audio.play().catch(e => console.log('Audio play c·∫ßn t∆∞∆°ng t√°c:', e));
                isRunning = true;
                requestAnimationFrame(loop);
            });

            // T·ªëi ∆∞u hi·ªÉn th·ªã s·ªë particle cho iPhone (th√¥ng b√°o nh·∫π)
            let statsDiv = document.getElementById('stats');
            setInterval(() => {
                if (isRunning) {
                    statsDiv.innerHTML = `‚ú® particles: ${particles.length} | shells: ${shells.length}`;
                }
            }, 300);
        })();
    </script>
</body>

</html>


